<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>126Verse Hub</title>
    <link rel="icon" type="image/gif" href="rocket.gif">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .bg-felix { background: linear-gradient(135deg, #0a66c2 0%, #004182 100%); }
        .bg-126v { background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .status-badge { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 4px 8px; rounded: 6px; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .account-switcher { transition: all 0.3s ease; }
        .account-active { background: rgba(255,255,255,0.2); font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }
        .account-inactive { opacity: 0.6; }
        .upload-loading { position: absolute; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="app-container relative flex flex-col">
        <header id="mainHeader" class="bg-felix px-5 pt-6 pb-4 sticky top-0 z-30 shadow-md text-white transition-colors duration-500">
            <div class="flex justify-center mb-4 bg-black/20 p-1 rounded-2xl backdrop-blur-md mx-4">
                <button onclick="switchAccount('felix')" id="btn-acc-felix" class="account-switcher flex-1 py-2 text-sm rounded-xl flex items-center justify-center gap-2 account-active"><i class="fa-solid fa-user-tie"></i> Felix</button>
                <button onclick="switchAccount('126v')" id="btn-acc-126v" class="account-switcher flex-1 py-2 text-sm rounded-xl flex items-center justify-center gap-2 account-inactive"><i class="fa-solid fa-building"></i> 126V</button>
            </div>
            <div class="flex justify-between items-center mb-3 px-1">
                <div><h1 class="font-bold text-xl tracking-tight" id="headerTitle">Personal Brand</h1><p class="text-blue-100 text-xs opacity-90" id="currentDate">...</p></div>
                <button onclick="loadData()" class="bg-white/10 p-2 rounded-full backdrop-blur-sm border border-white/20 active:scale-90 transition-transform"><i id="reloadIcon" class="fa-solid fa-sync text-white"></i></button>
            </div>
            <div class="flex bg-black/10 p-1 rounded-xl backdrop-blur-md">
                <button onclick="switchTab('todo')" id="tab-todo" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-gray-800 shadow-sm transition-all">Cần làm</button>
                <button onclick="switchTab('all')" id="tab-all" class="flex-1 py-2 text-sm font-bold rounded-lg text-white hover:bg-white/10 transition-all">Tất cả</button>
            </div>
        </header>

        <div id="postList" class="p-4 space-y-3 pb-24 bg-gray-50 flex-1 overflow-y-auto min-h-[60vh]">
            <div class="flex flex-col items-center justify-center pt-20 text-gray-400 space-y-3"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-gray-400"></i><p class="text-sm">Đang tải dữ liệu...</p></div>
        </div>
    </div>

    <div id="postModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 flex flex-col max-h-[95vh] animate-[slideUp_0.3s_ease-out] relative">
            
            <button onclick="closeModal()" class="absolute top-4 right-4 z-50 bg-gray-100 w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-all active:scale-95">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>

            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
            
            <div class="flex-1 overflow-y-auto hide-scrollbar pb-4">
                <div class="flex items-center justify-between mb-3">
                    <span id="modalCategory" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 uppercase tracking-wide">...</span>
                    <span id="modalDate" class="text-xs font-semibold text-gray-400">...</span>
                </div>
                <h2 id="modalTopic" class="text-xl font-bold text-gray-900 leading-snug mb-4">...</h2>
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 relative group mb-4">
                    <button onclick="copyContent()" class="absolute top-2 right-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100 text-gray-400 hover:text-blue-600 active:scale-95 transition-all z-10"><i class="fa-regular fa-copy text-lg"></i></button>
                    <p id="modalContent" class="text-gray-700 whitespace-pre-wrap text-sm leading-relaxed font-sans pr-2" style="font-size: 0.95rem; line-height: 1.6;">...</p>
                </div>

                <div id="imageArea">
                    <div class="text-xs font-bold text-gray-500 uppercase mb-2 ml-1 flex justify-between">
                        <span>Trạng thái hình ảnh</span>
                        <label for="fileInput" class="text-blue-600 cursor-pointer hover:underline text-xs flex items-center">
                            <i class="fa-solid fa-cloud-arrow-up mr-1"></i>Đổi ảnh
                        </label>
                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileSelect(event)">
                    </div>

                    <div id="dropZone" class="rounded-xl overflow-hidden border-2 border-dashed border-gray-300 bg-gray-50 min-h-[120px] flex flex-col items-center justify-center transition-all p-4" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                        
                        <div id="uploadLoader" class="upload-loading hidden">
                            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600 mb-2"></i>
                            <p class="text-xs font-bold text-gray-600">Đang xử lý...</p>
                        </div>

                        <div id="statusNoImage" class="text-center">
                            <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center mx-auto mb-2 text-gray-400">
                                <i class="fa-solid fa-image text-xl"></i>
                            </div>
                            <p class="text-xs text-gray-400">Chưa có ảnh. Kéo thả vào đây.</p>
                        </div>

                        <div id="statusHasImage" class="hidden text-center w-full">
                            <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3 mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                        <i class="fa-solid fa-check"></i>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-sm font-bold text-green-700">Đã có ảnh</p>
                                        <p class="text-[10px] text-green-600">Sẵn sàng để đăng</p>
                                    </div>
                                </div>
                                <button onclick="openImageNewTab()" class="text-xs bg-white border border-green-200 text-green-700 px-3 py-1.5 rounded-md font-bold hover:bg-green-100">
                                    Mở xem
                                </button>
                            </div>
                            <p class="text-[10px] text-gray-400">Muốn đổi ảnh khác? Kéo thả ảnh mới vào đây.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-3 mt-2 border-t border-gray-100">
                <button id="btnMarkDone" onclick="markAsDone()" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-all flex justify-center items-center text-base">
                    Xác nhận ĐÃ ĐĂNG
                </button>
            </div>
        </div>
    </div>

    <script>
        // CẤU HÌNH
        const SPREADSHEET_ID = "12Zd-Rn700gbt-_EkglFX2REc3ngUY4V8Z---yu69aRo";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwtsB-4Wi_yhF4EwNIxEzeqkx7wckNIcnYZqemJ-ZdPC7OM4eAuhzTUERZHl91rVCm-jw/exec"; 

        const ACCOUNTS = {
            'felix': { sheetName: "Felix", colorClass: "bg-felix", title: "Felix's Brand", storageKey: "Done_Felix" },
            '126v': { sheetName: "126V", colorClass: "bg-126v", title: "126Verse Company", storageKey: "Done_Company" }
        };

        let currentAccount = 'felix';
        let POSTS_DATA = [];
        let currentTab = 'todo';
        let selectedId = null;
        let currentImgUrl = "";
        let doneList = [];
        let localImageCache = JSON.parse(localStorage.getItem('126Verse_Local_Images')) || {};

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long' });
            const savedAcc = localStorage.getItem('last_acc');
            if(savedAcc && ACCOUNTS[savedAcc]) switchAccount(savedAcc);
            else loadData();
        });

        // --- LOAD DATA (Dùng Google CSV) ---
        function loadData() {
            const icon = document.getElementById('reloadIcon');
            icon.classList.add('fa-spin');
            doneList = JSON.parse(localStorage.getItem(ACCOUNTS[currentAccount].storageKey)) || [];
            localImageCache = JSON.parse(localStorage.getItem('126Verse_Local_Images')) || {};

            const csvUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${ACCOUNTS[currentAccount].sheetName}&t=${Date.now()}`;

            Papa.parse(csvUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    icon.classList.remove('fa-spin');
                    if (results.data && results.data.length > 0) {
                        POSTS_DATA = results.data.filter(row => row.id).map(row => {
                            const cacheKey = currentAccount + "_" + row.id;
                            const finalImage = localImageCache[cacheKey] || row.image_url;
                            return {
                                id: row.id.trim(),
                                date: row.date || "", category: row.category || "General",
                                topic: row.topic || "No Title", content: row.content || "",
                                image_url: finalImage
                            };
                        });
                        renderList();
                    } else document.getElementById('postList').innerHTML = `<div class="py-16 text-center opacity-50"><p>Chưa có dữ liệu.</p></div>`;
                },
                error: function(err) { icon.classList.remove('fa-spin'); console.log(err); }
            });
        }

        // --- RENDER LIST (CẬP NHẬT: DÙNG ẢNH GIF/PNG THAY ICON) ---
        function renderList() {
            const container = document.getElementById('postList');
            container.innerHTML = '';
            
            if (!POSTS_DATA || POSTS_DATA.length === 0) { container.innerHTML = `<div class="py-16 text-center opacity-50"><i class="fa-solid fa-box-open text-4xl mb-4 text-gray-300"></i><p>Trống!</p></div>`; return; }

            let validPosts = POSTS_DATA.filter(p => p.date);
            validPosts.sort((a, b) => new Date(a.date) - new Date(b.date));
            let displayPosts = currentTab === 'todo' ? validPosts.filter(p => !doneList.includes(p.id)) : validPosts;

            if (!displayPosts.length) { container.innerHTML = `<div class="py-16 text-center opacity-50"><i class="fa-solid fa-check-circle text-4xl mb-4 text-green-300"></i><p>Đã xong hết việc!</p></div>`; return; }

            displayPosts.forEach(post => {
                const isDone = doneList.includes(post.id);
                let dateStr = post.date;
                try { dateStr = new Date(post.date).toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}); } catch(e){}
                const badgeColor = currentAccount === 'felix' ? 'text-blue-600 bg-blue-50' : 'text-purple-600 bg-purple-50';
                
                // --- THAY ĐỔI Ở ĐÂY: DÙNG done.gif VÀ notyet.png ---
                let iconHTML = '';
                if(post.image_url && post.image_url.length > 5) {
                    // CÓ ẢNH -> Hiện done.gif
                    iconHTML = `
                    <div class="w-12 h-12 rounded-lg bg-blue-50 border border-blue-100 flex items-center justify-center flex-shrink-0 p-2">
                        <img src="done.gif" alt="Đã có ảnh" class="w-full h-full object-contain">
                    </div>`;
                } else {
                    // KHÔNG ẢNH -> Hiện notyet.png
                    iconHTML = `
                    <div class="w-12 h-12 rounded-lg bg-gray-50 border border-gray-200 flex items-center justify-center flex-shrink-0 opacity-60 p-3">
                        <img src="notyet.png" alt="Chưa có ảnh" class="w-full h-full object-contain">
                    </div>`;
                }

                container.insertAdjacentHTML('beforeend', `
                <div onclick="openModal('${post.id}')" class="bg-white p-4 rounded-2xl card-shadow mb-3 active:scale-[0.98] transition-transform cursor-pointer border border-gray-100 ${isDone ? 'opacity-60 grayscale' : 'opacity-100'}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md min-w-[50px] text-center">${dateStr}</span><span class="text-[10px] font-bold uppercase ${badgeColor} px-2 py-1 rounded line-clamp-1">${post.category}</span></div>
                        ${isDone ? '<span class="status-badge bg-green-100 text-green-700"><i class="fa-solid fa-check"></i> Xong</span>' : '<span class="status-badge bg-yellow-100 text-yellow-800">Chưa</span>'}
                    </div>
                    <div class="flex gap-3">
                        ${iconHTML}
                        <h3 class="font-bold text-gray-800 leading-snug line-clamp-2 flex-1 text-[15px]">${post.topic}</h3>
                    </div>
                </div>`);
            });
        }

        // --- UPDATE UI TRONG MODAL ---
        function updateImageStatusUI(url) {
            const noImgDiv = document.getElementById('statusNoImage');
            const hasImgDiv = document.getElementById('statusHasImage');
            const dropZone = document.getElementById('dropZone');
            
            if (url && url.length > 5) {
                noImgDiv.classList.add('hidden');
                hasImgDiv.classList.remove('hidden');
                dropZone.classList.add('bg-green-50', 'border-green-300');
                dropZone.classList.remove('bg-gray-50', 'border-gray-300');
            } else {
                noImgDiv.classList.remove('hidden');
                hasImgDiv.classList.add('hidden');
                dropZone.classList.remove('bg-green-50', 'border-green-300');
                dropZone.classList.add('bg-gray-50', 'border-gray-300');
            }
        }

        function openImageNewTab() {
            if(currentImgUrl) window.open(currentImgUrl, '_blank');
        }

        // --- UPLOAD LOGIC ---
        function resizeAndCompressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = function() {
                        let w = img.width, h = img.height; if (w > maxWidth) { h = h * (maxWidth / w); w = maxWidth; }
                        const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                        resolve({ base64: canvas.toDataURL('image/jpeg', quality).split(',')[1], mimeType: 'image/jpeg' });
                    }
                };
            });
        }

        async function uploadProcess(file) {
            if (!file.type.startsWith('image/')) return Swal.fire('Chỉ chọn file ảnh!');
            const loader = document.getElementById('uploadLoader');
            loader.classList.remove('hidden');

            try {
                const compressed = await resizeAndCompressImage(file, 1000, 0.7);
                const formData = new URLSearchParams();
                formData.append('spreadsheetId', SPREADSHEET_ID);
                formData.append('sheetName', ACCOUNTS[currentAccount].sheetName);
                formData.append('id', selectedId);
                formData.append('imageBase64', compressed.base64);
                formData.append('mimeType', compressed.mimeType);

                const response = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: formData });
                const result = await response.json();

                if (result.result === "success") {
                    const newLink = result.imageUrl;
                    currentImgUrl = newLink;
                    
                    // Update UI & Cache
                    updateImageStatusUI(newLink);
                    const cacheKey = currentAccount + "_" + selectedId;
                    localImageCache[cacheKey] = newLink; 
                    localStorage.setItem('126Verse_Local_Images', JSON.stringify(localImageCache));

                    const postIdx = POSTS_DATA.findIndex(p => p.id == selectedId);
                    if(postIdx > -1) POSTS_DATA[postIdx].image_url = newLink;

                    renderList();
                    Swal.fire({ icon: 'success', title: 'Thành công!', toast: true, position: 'top', timer: 2000 });
                } else throw new Error(result.error);

            } catch (err) {
                console.error(err);
                Swal.fire('Lỗi', 'Không thể upload: ' + err.message, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- CORE FUNCTIONS ---
        function switchAccount(accKey) {
            currentAccount = accKey; localStorage.setItem('last_acc', accKey);
            const config = ACCOUNTS[accKey];
            document.getElementById('mainHeader').className = `px-5 pt-6 pb-4 sticky top-0 z-30 shadow-md text-white transition-colors duration-500 ${config.colorClass}`;
            document.getElementById('headerTitle').innerText = config.title;
            document.getElementById('btn-acc-felix').className = `account-switcher flex-1 py-2 text-sm rounded-xl flex items-center justify-center gap-2 ${accKey === 'felix' ? 'account-active' : 'account-inactive'}`;
            document.getElementById('btn-acc-126v').className = `account-switcher flex-1 py-2 text-sm rounded-xl flex items-center justify-center gap-2 ${accKey === '126v' ? 'account-active' : 'account-inactive'}`;
            loadData();
        }
        function openModal(id) {
            selectedId = id; const post = POSTS_DATA.find(p => p.id == id); const isDone = doneList.includes(post.id);
            document.getElementById('modalCategory').innerText = post.category;
            document.getElementById('modalDate').innerText = post.date; 
            document.getElementById('modalTopic').innerText = post.topic;
            document.getElementById('modalContent').innerText = (post.content || "").replace(/\\n/g, '\n');
            
            const cacheKey = currentAccount + "_" + post.id;
            currentImgUrl = localImageCache[cacheKey] || post.image_url;
            updateImageStatusUI(currentImgUrl);

            const btn = document.getElementById('btnMarkDone');
            const btnClass = currentAccount === 'felix' ? 'bg-[#0a66c2]' : 'bg-[#6200ea]';
            if (isDone) { btn.innerText = "Đã đăng"; btn.className = "w-full bg-gray-200 text-gray-500 font-bold py-3.5 rounded-xl cursor-not-allowed"; btn.disabled = true; }
            else { btn.innerHTML = `Xác nhận ĐÃ ĐĂNG`; btn.className = `w-full ${btnClass} text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-all`; btn.disabled = false; }
            document.getElementById('postModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('postModal').classList.add('hidden'); }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDrop(e) { e.preventDefault(); if (e.dataTransfer.files.length) uploadProcess(e.dataTransfer.files[0]); }
        function handleFileSelect(e) { if (e.target.files.length) uploadProcess(e.target.files[0]); }
        function copyContent() { navigator.clipboard.writeText(document.getElementById('modalContent').innerText).then(() => Swal.fire({icon:'success', title:'Đã copy!', toast:true, position:'top', timer:1000})); }
        function switchTab(tab) {
            currentTab = tab;
            const activeColor = currentAccount === 'felix' ? 'text-blue-900' : 'text-purple-900';
            document.getElementById('tab-todo').className = `flex-1 py-2 text-sm font-bold rounded-lg ${tab === 'todo' ? 'bg-white ' + activeColor : 'text-white hover:bg-white/10'} shadow-sm transition-all`;
            document.getElementById('tab-all').className = `flex-1 py-2 text-sm font-bold rounded-lg ${tab === 'all' ? 'bg-white ' + activeColor : 'text-white hover:bg-white/10'} shadow-sm transition-all`;
            renderList();
        }
        function markAsDone() {
            if(!selectedId) return;
            if(!doneList.includes(selectedId)) { doneList.push(selectedId); localStorage.setItem(ACCOUNTS[currentAccount].storageKey, JSON.stringify(doneList)); }
            closeModal(); renderList();
        }
    </script>
</body>
</html>


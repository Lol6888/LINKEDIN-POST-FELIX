<script>
        // ==========================================
        // CẤU HÌNH (LINK CỦA BẠN)
        // ==========================================
        const SPREADSHEET_ID = "12Zd-Rn700gbt-_EkglFX2REc3ngUY4V8Z---yu69aRo";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziupYJyxsqLql8y27ZwKAUcJH5zq8t9NnQw33Dcd0sHAH6NsLgf7ukkdcdyGlv6YWSvA/exec"; // <--- Nhớ dán link Script vào đây nhé

        const ACCOUNTS = {
            'felix': { sheetName: "Felix", colorClass: "bg-felix", title: "Felix's Brand", storageKey: "Done_Felix" },
            '126v': { sheetName: "126V", colorClass: "bg-126v", title: "126Verse Company", storageKey: "Done_Company" }
        };

        let currentAccount = 'felix';
        let POSTS_DATA = [];
        let currentTab = 'todo';
        let selectedId = null;
        let currentImgUrl = "";
        let doneList = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long' });
            const savedAcc = localStorage.getItem('last_acc');
            if(savedAcc && ACCOUNTS[savedAcc]) switchAccount(savedAcc);
            else loadData();
        });

        // --- HÀM XỬ LÝ LINK ẢNH THÔNG MINH ---
        function processImageUrl(url) {
            if (!url) return "";
            url = url.trim();
            
            // 1. Nếu là link trực tiếp từ Script (drive.google.com/uc...) -> Giữ nguyên
            if (url.includes("drive.google.com/uc")) return url;

            // 2. Nếu là link share thường (drive.google.com/file/d/...) -> Chuyển thành link xem được
            if (url.includes("/d/")) {
                const match = url.match(/\/d\/(.+?)(\/|$)/);
                if (match && match[1]) {
                    // Dùng link lh3.googleusercontent.com để load nhanh hơn
                    return `https://lh3.googleusercontent.com/d/${match[1]}`;
                }
            }
            return url;
        }

        function switchAccount(accKey) {
            currentAccount = accKey;
            localStorage.setItem('last_acc', accKey);
            const config = ACCOUNTS[accKey];
            const header = document.getElementById('mainHeader');
            header.className = `px-5 pt-6 pb-4 sticky top-0 z-30 shadow-md text-white transition-colors duration-500 ${config.colorClass}`;
            document.getElementById('headerTitle').innerText = config.title;
            document.getElementById('btn-acc-felix').className = `account-switcher flex-1 py-2 text-sm rounded-xl flex items-center justify-center gap-2 ${accKey === 'felix' ? 'account-active' : 'account-inactive'}`;
            document.getElementById('btn-acc-126v').className = `account-switcher flex-1 py-2 text-sm rounded-xl flex items-center justify-center gap-2 ${accKey === '126v' ? 'account-active' : 'account-inactive'}`;
            loadData();
        }

        function loadData() {
            const icon = document.getElementById('reloadIcon');
            icon.classList.add('fa-spin');
            doneList = JSON.parse(localStorage.getItem(ACCOUNTS[currentAccount].storageKey)) || [];
            
            // Thêm timestamp để hạn chế cache trình duyệt
            fetch(`https://opensheet.elk.sh/${SPREADSHEET_ID}/${ACCOUNTS[currentAccount].sheetName}?t=${Date.now()}`)
                .then(res => res.json())
                .then(data => {
                    icon.classList.remove('fa-spin');
                    if (data && !data.error) {
                        POSTS_DATA = data.filter(row => row.id).map(row => ({
                            id: row.id.toString().trim(),
                            date: row.date || "", 
                            category: row.category || "General",
                            topic: row.topic || "No Title", 
                            content: row.content || "",
                            image_url: processImageUrl(row.image_url)
                        }));
                        renderList();
                    } else showError("Lỗi Sheet hoặc Sheet rỗng.");
                })
                .catch(err => { icon.classList.remove('fa-spin'); showError("Lỗi kết nối."); });
        }

        // --- UPLOAD LOGIC ---
        function handleDragOver(e) { e.preventDefault(); document.getElementById('dropZone').classList.add('bg-blue-50', 'border-blue-400'); }
        function handleDrop(e) { 
            e.preventDefault(); 
            document.getElementById('dropZone').classList.remove('bg-blue-50', 'border-blue-400');
            if (e.dataTransfer.files.length) uploadProcess(e.dataTransfer.files[0]);
        }
        function handleFileSelect(e) { if (e.target.files.length) uploadProcess(e.target.files[0]); }

        async function uploadProcess(file) {
            if (!file.type.startsWith('image/')) return Swal.fire('Chỉ chọn file ảnh!');
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("DÁN_LINK")) return Swal.fire('Chưa điền link Apps Script!');

            const loader = document.getElementById('uploadLoader');
            loader.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Data = e.target.result.split(',')[1];
                const mimeType = file.type;

                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({
                            spreadsheetId: SPREADSHEET_ID,
                            sheetName: ACCOUNTS[currentAccount].sheetName,
                            id: selectedId,
                            imageBase64: base64Data,
                            mimeType: mimeType
                        })
                    });

                    const result = await response.json();

                    if (result.result === "success") {
                        loader.classList.add('hidden');
                        
                        // 1. Cập nhật UI trong Modal ngay lập tức (dùng Blob cho nhanh)
                        const blobUrl = URL.createObjectURL(file);
                        updateImageUI(blobUrl);
                        currentImgUrl = blobUrl; // Lưu tạm blob để xem
                        
                        // 2. Cập nhật Dữ liệu gốc bằng link thật từ Server trả về
                        const postIdx = POSTS_DATA.findIndex(p => p.id == selectedId);
                        if(postIdx > -1) {
                            POSTS_DATA[postIdx].image_url = processImageUrl(result.imageUrl);
                        }

                        // 3. [QUAN TRỌNG] Cập nhật lại danh sách bên ngoài để hiện Thumbnail
                        renderList();

                        Swal.fire({ icon: 'success', title: 'Thành công!', text: 'Ảnh đã được lưu.', toast: true, position: 'top', timer: 2000 });
                    } else {
                        throw new Error(result.error || "Lỗi từ Script");
                    }

                } catch (err) {
                    loader.classList.add('hidden');
                    console.error(err);
                    Swal.fire('Lỗi Upload', 'Không thể kết nối. Kiểm tra lại Apps Script.', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        function updateImageUI(url) {
            const preview = document.getElementById('modalImagePreview');
            const placeholder = document.getElementById('imgPlaceholder');
            const toolbar = document.getElementById('imgToolbar');
            
            if (url) {
                preview.src = url; preview.classList.remove('hidden');
                placeholder.classList.add('hidden'); toolbar.classList.remove('hidden');
            } else {
                preview.src = ""; preview.classList.add('hidden');
                placeholder.classList.remove('hidden'); toolbar.classList.add('hidden');
            }
        }

        function renderList() {
            const container = document.getElementById('postList');
            container.innerHTML = '';
            let validPosts = POSTS_DATA.filter(p => p.date);
            validPosts.sort((a, b) => new Date(a.date) - new Date(b.date));
            let displayPosts = currentTab === 'todo' ? validPosts.filter(p => !doneList.includes(p.id)) : validPosts;

            if (!displayPosts.length) { container.innerHTML = `<div class="py-16 text-center opacity-50"><i class="fa-solid fa-box-open text-4xl mb-4 text-gray-300"></i><p>Trống!</p></div>`; return; }

            displayPosts.forEach(post => {
                const isDone = doneList.includes(post.id);
                let dateStr = post.date;
                try { dateStr = new Date(post.date).toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}); } catch(e){}
                const badgeColor = currentAccount === 'felix' ? 'text-blue-600 bg-blue-50' : 'text-purple-600 bg-purple-50';
                
                // Render Thumbnail (nếu có)
                let thumbHTML = '';
                if(post.image_url) {
                    thumbHTML = `<div class="w-12 h-12 rounded-lg bg-gray-100 flex-shrink-0 bg-cover bg-center border border-gray-200" style="background-image: url('${post.image_url}')"></div>`;
                }

                container.insertAdjacentHTML('beforeend', `
                <div onclick="openModal('${post.id}')" class="bg-white p-4 rounded-2xl card-shadow mb-3 active:scale-[0.98] transition-transform cursor-pointer border border-gray-100 ${isDone ? 'opacity-60 grayscale' : 'opacity-100'}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md min-w-[50px] text-center">${dateStr}</span><span class="text-[10px] font-bold uppercase ${badgeColor} px-2 py-1 rounded line-clamp-1">${post.category}</span></div>
                        ${isDone ? '<span class="status-badge bg-green-100 text-green-700"><i class="fa-solid fa-check"></i> Xong</span>' : '<span class="status-badge bg-yellow-100 text-yellow-800">Chưa</span>'}
                    </div>
                    <div class="flex gap-3">
                        ${thumbHTML}
                        <h3 class="font-bold text-gray-800 leading-snug line-clamp-2 flex-1 text-[15px]">${post.topic}</h3>
                    </div>
                </div>`);
            });
        }

        function openModal(id) {
            selectedId = id;
            const post = POSTS_DATA.find(p => p.id == id);
            const isDone = doneList.includes(post.id);
            
            document.getElementById('modalCategory').innerText = post.category;
            document.getElementById('modalDate').innerText = post.date; 
            document.getElementById('modalTopic').innerText = post.topic;
            document.getElementById('modalContent').innerText = (post.content || "").replace(/\\n/g, '\n');
            
            // Xử lý link ảnh
            currentImgUrl = processImageUrl(post.image_url);
            updateImageUI(currentImgUrl);

            const btn = document.getElementById('btnMarkDone');
            const btnClass = currentAccount === 'felix' ? 'bg-[#0a66c2]' : 'bg-[#6200ea]';
            
            if (isDone) {
                btn.innerText = "Đã đăng"; btn.className = "w-full bg-gray-200 text-gray-500 font-bold py-3.5 rounded-xl cursor-not-allowed"; btn.disabled = true;
            } else {
                btn.innerHTML = `Xác nhận ĐÃ ĐĂNG`; btn.className = `w-full ${btnClass} text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-all`; btn.disabled = false;
            }
            document.getElementById('postModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('postModal').classList.add('hidden'); }
        function switchTab(tab) {
            currentTab = tab;
            const activeColor = currentAccount === 'felix' ? 'text-blue-900' : 'text-purple-900';
            document.getElementById('tab-todo').className = `flex-1 py-2 text-sm font-bold rounded-lg ${tab === 'todo' ? 'bg-white ' + activeColor : 'text-white hover:bg-white/10'} shadow-sm transition-all`;
            document.getElementById('tab-all').className = `flex-1 py-2 text-sm font-bold rounded-lg ${tab === 'all' ? 'bg-white ' + activeColor : 'text-white hover:bg-white/10'} shadow-sm transition-all`;
            renderList();
        }
        function copyContent() { navigator.clipboard.writeText(document.getElementById('modalContent').innerText).then(() => Swal.fire({icon:'success', title:'Đã copy!', toast:true, position:'top', timer:1000})); }
        function downloadImageBtn() { if(currentImgUrl) window.open(currentImgUrl, '_blank'); }
        async function copyImageBtn() {
             if (!currentImgUrl) return;
             try { const res = await fetch(currentImgUrl); const blob = await res.blob(); await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]); Swal.fire({icon:'success', title:'Copied!', toast:true, position:'top'}); } 
             catch(e) { Swal.fire({icon:'info', title:'Nhấn giữ ảnh để copy'}); }
        }
        function previewImageFull() { if(currentImgUrl) window.open(currentImgUrl, '_blank'); }
        function markAsDone() {
            if(!selectedId) return;
            if(!doneList.includes(selectedId)) { doneList.push(selectedId); localStorage.setItem(ACCOUNTS[currentAccount].storageKey, JSON.stringify(doneList)); }
            closeModal(); renderList();
        }
        function showError(msg) { console.log(msg); }
    </script>
